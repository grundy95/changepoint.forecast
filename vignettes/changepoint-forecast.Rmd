---
title: "changepoint.forecast"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{changepoint.forecast}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(changepoint.forecast)
```

`changepoint.forecast` is an R package for detecting changepoints using forecast errors. This package is currently in development and thorough testing has not been performed.

The main function is `cptForecast`. This function takes forecast errors along with additional information such as the length of the training period where the errors are assumed stable and the type of CUSUM detector to use. The function works by running the CUSUM detector on the forecast errors and the squared forecast errors (the former is designed to detect mean changes and the later for second-order changes). The theoretical critical values of the CUSUM detectors can either be calculated with `critValue='Simulate'` and specifying additional arguments or can be looked up from a pre-calculated table of values using `critValue='Lookup'`. Otherwise a manual critValue can be entered. The type-1 error rate `alpha` can be set using the argument `alpha`.

The returned object is an S4 class `cptFor`. This object contains the time when a changepoint was detected `tau` for the forecast errors and `tau2` for the squared forecast errors, along with other additional information that can be found in the documentation. Slots of this class can be accessed using `@` as shown below and a plot methods is also available for this class. 


The example below simulates 500 forecast errors, the training period will be set to `m=300` and at time point 400 there is a changepoint in the mean. 

```{r basicExample}
set.seed(1)
errors = c(rnorm(400),rnorm(100,2))
m = 300

out = cptForecast(errors=errors, m=m, detector='PageCUSUM', critValue='Lookup', alpha=0.05)
out@tau
out@tau2
plot(out)

```


## Online Implmentation 
The function `cptForecast` and `updateForecast` can be used to analyse forecast errors as they become available. Say we have 300 forecast errors as training data and then we have started monitoring new forecast errors for 100 time points. We can see if any changes have been detected in the first 100 time points similarly to above.

```{r inital}
set.seed(1)
errors = rnorm(400)
ans = cptForecast(errors, m=300)
summary(ans)
```

We can see from the summary that no changepoints have been detected (as expected). Now lets assume we have the new 10 time points available. We can update our analysis without having to re-analyse all the previous 400 timepoints using the `updateForecast` function.

```{r update}
set.seed(1)
newErrors = rnorm(10)
ans = updateForecast(newErrors, model=ans)
summary(ans)
```
We can see still no changes have been detected. You could easily set up a framework where as new data becomes available, the analysis is updated and a flag can be called if a change is detected

```{r online}
set.seed(1)
newErrors2 = rnorm(100, 2)
for(i in 1:length(newErrors2)){
  ans = updateForecast(newErrors2[i], model=ans)
  if(tau(ans)<Inf||tau2(ans)<Inf){
    Tau = min(tau(ans), tau2(ans))
    print(paste0("Changepoint detected at time point ", Tau, ". Stopping analysis"))
    break
  }
}
summary(ans)
plot(ans)
```



